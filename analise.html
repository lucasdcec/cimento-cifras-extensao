<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análise Financeira</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <h1>Cimento & Cifras</h1>
        <nav>
          <ul>
            <li><a href="./index.html">Página Inicial</a></li>
            <li><a href="./analise.html">Análise Financeira</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <section>
      <h2>Análise Completa</h2>
      <div id="loading" class="loading">Carregando dados...</div>
      <div id="charts-container" class="charts-grid"></div>
      <div id="error" class="error"></div>
    </section>
  </main>

  <footer>
    <div class="container"><p>&copy; 2025 Cimento & Cifras</p></div>
  </footer>

<script>
    // URL da planilha exportada como CSV
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1VAWN9Q8OmK3aHwg_GGZAqxNtW_RxqLikDR6HV2uj9x0/export?format=csv"

    // Paleta de cores usada nos gráficos
    const CORES = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF']

    // Perguntas exatamente como aparecem no CSV
    // A ordem define a ordem dos gráficos
    const PERGUNTAS = [
      'Qual é o seu grau de escolaridade?',
      'Quantos dias no mês você geralmente trabalha?',
      'Qual a sua renda média mensal?',
      'Qual sua área de atuação na construção civil?',
      'Você tem meio de transporte próprio?',
      'Qual o seu gasto médio com despesas fixas do trabalho (materiais, transporte, etc.)?',
      'Há quanto tempo você trabalha na área?',
      'Quantos integrantes tem sua família?',
      'Você tem algum conhecimento de investimento?',
      'Quanto você investe mensalmente?',
      'Qual tipo de investimento você faz?'
    ]

    // Mapeamento entre pergunta exibida e coluna do CSV
    // Facilita manutenção caso no futuro algum cabeçalho mude
    const MAPA_CABECALHO = PERGUNTAS.reduce((m,p)=>{ m[p]=p; return m }, {})

    // Explicações exibidas abaixo de cada gráfico/tabela
    const ANALISES = {
      'Qual é o seu grau de escolaridade?': 'Análise do perfil educacional...',
      'Quantos dias no mês você geralmente trabalha?':'Análise da frequência...',
      'Qual a sua renda média mensal?':'Análise da renda...',
      'Qual sua área de atuação na construção civil?':'Áreas predominantes...',
      'Você tem meio de transporte próprio?':'Impacto da mobilidade...',
      'Qual o seu gasto médio com despesas fixas do trabalho (materiais, transporte, etc.)?':'Custos operacionais...',
      'Há quanto tempo você trabalha na área?':'Experiência...',
      'Quantos integrantes tem sua família?':'Contexto familiar...',
      'Você tem algum conhecimento de investimento?':'Educação financeira...',
      'Quanto você investe mensalmente?':'Hábito de investir...',
      'Qual tipo de investimento você faz?':'Perfil de investidor...',

      // Tabelas cruzadas
      'ESCOLARIDADE_AREA':'Relação escolaridade × área...',
      'RENDA_TRANSPORTE':'Renda × transporte...',
      'ESCOLARIDADE_INVESTIMENTO':'Escolaridade × investimentos...',
      'RENDA_INVESTIMENTO_MENSAL':'Renda × valor investido...',
      'TIPO_INVESTIMENTO_VALOR':'Tipo × valor...'
    }

    // Cria um gráfico dentro de um card visual, usando Chart.js
    function criarGrafico(container, titulo, labels, dados, tipo='pie', explicacao='') {
      const card = document.createElement('div')
      card.className = 'chart-card'

      const title = document.createElement('div')
      title.className = 'chart-title'
      title.textContent = titulo
      card.appendChild(title)

      const canvas = document.createElement('canvas')
      card.appendChild(canvas)

      const analise = document.createElement('div')
      analise.className = 'chart-explanation'
      analise.innerHTML = `<strong>Análise:</strong> ${explicacao}`
      card.appendChild(analise)

      container.appendChild(card)

      // Criação do gráfico
      new Chart(canvas, {
        type: tipo, // corrigido para evitar erro "type is not defined"
        data: {
          labels,
          datasets: [{
            data: dados,
            backgroundColor: CORES,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      })
    }

    // Faz o parse manual de CSV considerando aspas e vírgulas internas
    // Necessário porque planilhas do Google não seguem um padrão simples
    function parseCSV(text){
      const rows = []
      let row = []
      let cell = ''
      let inQuotes = false

      for(let i=0;i<text.length;i++){
        const c = text[i]
        const next = text[i+1]

        if(c=='"'){
          if(inQuotes && next=='"'){
            cell += '"'
            i++
          } else {
            inQuotes = !inQuotes
          }
        } else if(c==',' && !inQuotes){
          row.push(cell)
          cell = ''
        } else if((c=='\n' || c=='\r') && !inQuotes){
          if(cell !== '' || row.length > 0){
            row.push(cell)
            rows.push([...row])
            row = []
            cell = ''
          }
          if(c=='\r' && next=='\n') i++
        } else {
          cell += c
        }
      }

      if(cell !== '' || row.length > 0){
        row.push(cell)
        rows.push(row)
      }

      return rows
    }

    // Limpa quebras de linha e aspas extras de valores do CSV
    const formatar = s =>
      (s||'')
        .replace(/\r/g,'')
        .replace(/\n/g,'')
        .replace(/^"+|"+$/g,'')
        .trim()

    // Carrega o CSV da planilha e devolve headers + lista de objetos
    async function carregarDados(){
      const r = await fetch(SHEET_URL)
      if(!r.ok) throw new Error(`Erro: ${r.status}`)

      const csv = await r.text()
      if(!csv.trim()) throw new Error('Planilha vazia')

      const rows = parseCSV(csv)
      const headers = rows[0].map(formatar)

      const dados = rows.slice(1).map(r=>{
        const obj = {}
        headers.forEach((h,i)=> obj[h] = formatar(r[i]))
        return obj
      })

      return { headers, dados }
    }

    // Cria um gráfico baseado na pergunta indicada
    // Conta automaticamente a frequência das respostas
    function processarPergunta(dados, pergunta, container, tipo='pie', explicacao=''){
      const freq = {}
      const cab = MAPA_CABECALHO[pergunta]

      dados.forEach(registro=>{
        const valor = registro[cab] || 'Não informado'
        freq[valor] = (freq[valor] || 0) + 1
      })

      criarGrafico(container, pergunta, Object.keys(freq), Object.values(freq), tipo, explicacao)
    }

    // Cria uma tabela cruzada comparando duas variáveis do CSV
    function criarTabelaCruzada(dados, p1, p2, container, explicacao=''){
      const tabela = {}

      dados.forEach(r=>{
        const a = r[p1] || 'Não informado'
        const b = r[p2] || 'Não informado'
        if(!tabela[a]) tabela[a] = {}
        tabela[a][b] = (tabela[a][b] || 0) + 1
      })

      const colunas = [...new Set(dados.map(r=> r[p2] || 'Não informado'))]

      const card = document.createElement('div')
      card.className = 'table-card'

      card.innerHTML = `
        <div class="table-title">${p1} × ${p2}</div>
        <div class="table-container">
          <table class="cross-table">
            <thead>
              <tr class="table-header-primary">
                <th rowspan="2" class="primary-header">${p1}</th>
                <th colspan="${colunas.length}" class="secondary-header">${p2}</th>
              </tr>
              <tr class="table-header-secondary">
                ${colunas.map(c=>`<th class="column-header">${c}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${Object.keys(tabela).map(v1=>`
                <tr>
                  <td class="row-header">${v1}</td>
                  ${colunas.map(v2=>{
                    const n = tabela[v1][v2] || 0
                    return `<td class="data-cell ${n>0?'has-data':''}">${n}</td>`
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `

      const analise = document.createElement('div')
      analise.className = 'chart-explanation'
      analise.innerHTML = `<strong>Análise:</strong> ${explicacao}`
      card.appendChild(analise)

      container.appendChild(card)
    }

    // Função principal executada ao carregar a página
    async function inicializar(){
      try{
        loading.style.display = 'block'

        const { headers, dados } = await carregarDados()

        loading.style.display = 'none'

        const container = document.getElementById('charts-container')

        // Cria todos os gráficos individuais
        PERGUNTAS.forEach((p,i)=>{
          const tipo = i%3===0 ? 'pie' : i%3===1 ? 'bar' : 'doughnut'
          const exp = ANALISES[p] || ''
          processarPergunta(dados, p, container, tipo, exp)
        })

        // Tabelas cruzadas
        criarTabelaCruzada(dados,
          "Qual é o seu grau de escolaridade?",
          "Qual sua área de atuação na construção civil?",
          container,
          ANALISES['ESCOLARIDADE_AREA']
        )

        criarTabelaCruzada(dados,
          "Qual a sua renda média mensal?",
          "Você tem meio de transporte próprio?",
          container,
          ANALISES['RENDA_TRANSPORTE']
        )

        criarTabelaCruzada(dados,
          "Qual é o seu grau de escolaridade?",
          "Qual tipo de investimento você faz?",
          container,
          ANALISES['ESCOLARIDADE_INVESTIMENTO']
        )

        criarTabelaCruzada(dados,
          "Qual a sua renda média mensal?",
          "Quanto você investe mensalmente?",
          container,
          ANALISES['RENDA_INVESTIMENTO_MENSAL']
        )

        criarTabelaCruzada(dados,
          "Qual tipo de investimento você faz?",
          "Quanto você investe mensalmente?",
          container,
          ANALISES['TIPO_INVESTIMENTO_VALOR']
        )

      } catch(e){
        loading.style.display = 'none'
        const el = document.getElementById('error')
        el.style.display = 'block'
        el.textContent = `Erro: ${e.message}`
      }
    }

    // Inicializa tudo quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', inicializar)
</script>

</body>
</html>
